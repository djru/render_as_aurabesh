<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Aurebesh Image Generator</title>
        <style>
            @font-face {
                font-family: "Aurabesh";
                /* The ?v=1 trick forces Chrome to reload the file fresh */
                src: url("AurebeshBold-Rw1l.ttf?v=1") format("truetype");
                font-display: swap;
                font-weight: normal;
                font-style: normal;
            }

            body {
                font-family: -apple-system, system-ui, sans-serif;
                background-color: #ffffff;
                color: #000;
                margin: 0;
                padding: 20px;
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            .container {
                width: 100%;
                max-width: 500px;
                display: flex;
                flex-direction: column;
                gap: 15px;
            }

            textarea {
                width: 100%;
                height: 80px;
                padding: 12px;
                box-sizing: border-box;
                border: 2px solid #000;
                border-radius: 12px;
                font-size: 16px;
                outline: none;
            }

            .instruction {
                font-size: 13px;
                color: #666;
                text-align: center;
                margin-bottom: 5px;
                font-weight: 500;
            }

            /* This is the final image the user interacts with */
            #finalImage {
                width: 100%;
                height: auto;
                border: 1px solid #eee;
                border-radius: 12px;
                display: block;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            }

            /* We keep the canvas hidden; it's just our 'engine' */
            #bufferCanvas {
                display: none;
            }

            .font-loader {
                font-family: "Aurabesh";
                visibility: hidden;
                position: absolute;
                height: 0;
            }
        </style>
    </head>
    <body>
        <div class="font-loader">Force Load</div>

        <div class="container">
            <textarea
                id="textInput"
                placeholder="Type your message..."
            ></textarea>

            <p class="instruction">Hold the image below to Save or Copy</p>

            <img id="finalImage" alt="Your Aurebesh text will appear here" />
        </div>

        <canvas id="bufferCanvas"></canvas>

        <script>
            const input = document.getElementById("textInput");
            const img = document.getElementById("finalImage");
            const canvas = document.getElementById("bufferCanvas");
            const ctx = canvas.getContext("2d");

            // Ensure font is ready before initial draw
            document.fonts.ready.then(() => {
                renderToImage();
            });

            input.addEventListener("input", renderToImage);

            function renderToImage() {
                const text = input.value || "Type Something";
                const lines = text.split("\n");
                const fontSize = 70;
                const padding = 60;
                const scale = 2; // For high-resolution Retina displays

                // 1. Measure text width
                ctx.font = `${fontSize}px aurabesh`;
                let maxW = 0;
                lines.forEach((line) => {
                    const metrics = ctx.measureText(line);
                    if (metrics.width > maxW) maxW = metrics.width;
                });

                // 2. Setup Canvas dimensions
                const logicalWidth = maxW + padding * 2;
                const logicalHeight =
                    lines.length * fontSize * 1.2 + padding * 2;

                canvas.width = logicalWidth * scale;
                canvas.height = logicalHeight * scale;

                // Normalize coordinates for the scale
                ctx.scale(scale, scale);

                // 3. Draw Background
                ctx.fillStyle = "#ffffff";
                ctx.fillRect(0, 0, logicalWidth, logicalHeight);

                // 4. Draw Text
                ctx.fillStyle = "#000000";
                ctx.font = `${fontSize}px aurabesh`;
                ctx.textAlign = "center";
                ctx.textBaseline = "top";

                lines.forEach((line, i) => {
                    ctx.fillText(
                        line,
                        logicalWidth / 2,
                        padding + i * fontSize * 1.2,
                    );
                });

                // 5. Convert Canvas to Base64 Data URL and push to <img> tag
                const dataUrl = canvas.toDataURL("image/png");
                img.src = dataUrl;
            }
        </script>
    </body>
</html>
